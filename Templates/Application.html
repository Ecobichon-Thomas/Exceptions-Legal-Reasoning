<!DOCTYPE html>
<html lang="fr">
    <head>
        <meta charset="utf-8">
        <title>Handling Unexpected Exceptions in Legal Reasoning</title>
        <link href="Application.css" rel="stylesheet">
    </head>
    <body>
        <header>
            <h1 id="ancre">Handling Unexpected Exceptions in Legal Reasoning</h1>
        </header>

        <main>

        <style>
            .api-select-container {
                position: absolute;
                top: 1em;
                right: 2em;
            }
        </style>

        <form method="post" action="/set_config">
            <label for="api">API :</label>
            <select name="api" id="api">
                {% for api_name in API %}
                    <option value="{{ api_name }}" {% if api_name == selected_api %}selected{% endif %}>
                        {{ api_name }}
                    </option>
                {% endfor %}
            </select>
            <input type="submit" value="Valider">
        </form>

        <form method="post" action="/upload_rules" enctype="multipart/form-data">
            <label for="w_choice">W :</label>
            <select name="w_choice" id="w_choice" onchange="toggleWUpload()">
                {% for w_name in W_files %}
                    <option value="{{ w_name }}" {% if w_name == selected_w %}selected{% endif %}>
                        {{ w_name }}
                    </option>
                {% endfor %}
                <option value="__upload__">Upload your files</option>
            </select>

            <div id="w_upload_fields" style="display: none; margin-top: 0.5em;">
                <label for="uploaded_w">Fichier W.txt :</label>
                <input type="file" name="uploaded_w" accept=".txt" required>
            </div>

            <label for="rb_choice">RB :</label>
            <select name="rb_choice" id="rb_choice" onchange="toggleRBUpload()">
                {% for rb_name in RB_files %}
                    <option value="{{ rb_name }}" {% if rb_name == selected_rb %}selected{% endif %}>
                        {{ rb_name }}
                    </option>
                {% endfor %}
                <option value="__upload__">Upload your files</option>
            </select>

            <div id="rb_upload_fields" style="display: none; margin-top: 0.5em;">
                <label for="uploaded_rb">Fichier RB.txt :</label>
                <input type="file" name="uploaded_rb" accept=".txt" required>
            </div>

            <br><input type="submit" value="Valider">
        </form>

        <script>
        function toggleRBUpload() {
            const rbSelect = document.getElementById("rb_choice");
            const rbUpload = document.getElementById("rb_upload_fields");

            if (rbSelect.value === "__upload__") {
                rbUpload.style.display = "block";
            } else {
                rbUpload.style.display = "none";
            }
        }
        </script>

        <script>
        function toggleWUpload() {
            const wSelect = document.getElementById("w_choice");
            const wUpload = document.getElementById("w_upload_fields");

            if (wSelect.value === "__upload__") {
                wUpload.style.display = "block";
            } else {
                wUpload.style.display = "none";
            }
        }
        </script>

        <!--
        <div style="position: absolute; top: 1em; right: 2em;">
            <form method="post" action="/set_config" style="display: flex; gap: 1em; align-items: center;">
                <label for="w_choice">W :</label>
                <select name="w_choice" id="w_choice">
                    {% for w_name in W_files %}
                        <option value="{{ w_name }}" {% if w_name == selected_w %}selected{% endif %}>
                            {{ w_name }}
                        </option>
                    {% endfor %}
                </select>

                <label for="rb_choice">RB :</label>
                <select name="rb_choice" id="rb_choice">
                    {% for rb_name in RB_files %}
                        <option value="{{ rb_name }}" {% if rb_name == selected_rb %}selected{% endif %}>
                            {{ rb_name }}
                        </option>
                    {% endfor %}
                </select>

                <label for="api">API :</label>
                <select name="api" id="api">
                    {% for api_name in API %}
                        <option value="{{ api_name }}" {% if api_name == selected_api %}selected{% endif %}>
                            {{ api_name }}
                        </option>
                    {% endfor %}
                </select>

                <input type="submit" value="Changer">
            </form>
        </div>

        <div style="margin-top: 2em;">
            <h4>Importer vos propres fichiers de règles :</h4>
            <form method="post" action="/upload_rules" enctype="multipart/form-data">
                <label for="file_w">Fichier W :</label>
                <input type="file" name="file_w" accept=".txt" required>

                <label for="file_p">Fichier P :</label>
                <input type="file" name="file_p" accept=".txt" required>

                <label for="file_c">Fichier C :</label>
                <input type="file" name="file_c" accept=".txt" required>

                <input type="submit" value="Uploader et utiliser">
            </form>
        </div>
        -->

        <h2>Veuillez soumettre un scénario ci-dessous:</h2>

        <form method="post" action="/traiter">
            <p>
                <textarea name="scenario1" id="scenario1" placeholder="Votre scénario" cols = 100></textarea>
            </p>
            <input type="submit" value="Envoyer">
        </form>

        {% if scenario %}
            <div id="scenario_initial">
                <h2>Scénario :</h2>
                <pre>{{ scenario }}</pre>
            </div>
        {% endif %}

        {% if resultat is defined %}
            <div id="resultat">
                <h2>Décomposition en prémices du scénario :</h2>
                <p>Le scénario a été découpé en prémices par le llm sélectionné. Voici la décomposition obtenue:</p>
                <p>{{ resultat }}</p>
            </div>
            <p>Si cette décomposition ne vous convient pas, vous pouvez donner des indications supplémentaires ici pour que le llm améliore sa réponse:</p>
            <form method="post" action="/traiter">
                <input type="hidden" name="scenario" value="{{ scenario }}">
                <input type="hidden" name="resultat" value="{{ resultat }}">
                <p>
                    <textarea name="complement" id="complement" placeholder="précisions pour le llm" cols = 100></textarea>
                </p>
                <input type="submit" value="Envoyer">
            </form>
        {% endif %}

        {% if No_rule %}
            <h2>Aucune règle ne s'applique au scénario fourni, veuillez ré-essayer</h2>
        {% endif %}

        {% if log %}
            <h2>Génération d'une extension: </h2>
            <p>Voici le déroulé de l'analyse du scénario par le système. Vous pouvez retrouver les différentes étapes de sélection des règles applicables</p>
            <pre>{{ log }}</pre>
        {% endif %}

        {% if loop %}
            <form id="auto-submit-form" method="post" action="/traiter">
                <input type="hidden" name="scenario" value="{{ scenario }}">
                <input type="hidden" name="resultat" value="{{ resultat }}">
                <textarea name="log" style="display:none;">{{ log }}</textarea>
            </form>

            <script>
                window.onload = function() {
                    document.getElementById("auto-submit-form").submit();
                };
            </script>
        {% endif %}

        {% if conflit %}
            <div id="choix_regle">
                <h2>Choix de la règle à appliquer :</h2>
                <p>Sélectionnez une règle parmi celles possibles ci-dessous:</p>

                <form method="post" action="/traiter">
                    <input type="hidden" name="scenario" value="{{ scenario }}">
                    <input type="hidden" name="resultat" value="{{ resultat }}">
                    <textarea name="log" style="display:none;">{{ log }}</textarea>

                    {% for option in options %}
                        <div>
                            <input type="radio" id="regle_{{ loop.index0 }}" name="user_choice" 
                            value="{{ indices[loop.index0] }}" {% if loop.first %}checked{% endif %} required>
                            <label for="regle_{{ loop.index0 }}">{{ option }}</label>
                        </div>
                    {% endfor %}

                    <div>
                        <input type="radio" id="regle_none" name="user_choice" value="-1" required>
                        <label for="regle_none">Ne pas sélectionner de règle</label>
                    </div>

                    <input type="submit" value="Valider le choix">
                </form>
            </div>
        {% endif %}

        {% if analyse %}
            {% if rule_str %}
                <div id="rule_str">
                    <h2>Règle finale appliquée :</h2>
                    <pre>La règle qui a été choisie parmi les règles applicables dans la situation courante est : {{ rule_str }}</pre>
                </div>
            {% endif %}
            <div id="analyse">
                <h2>Ecriture logique de la règle:</h2>
                <pre>{{ analyse }}</pre>
            </div>
        {% endif %}

        {% if extension %}
            <form method="post" action="/exceptions">
                <input type="hidden" name="scenario" value="{{ scenario }}">
                <input type="hidden" name="resultat" value="{{ resultat }}">
                <textarea name="log" style="display:none;">{{ log }}</textarea>
                <h2>Nous allons maintenant proposer de créer des exceptions à partir des règles sélectionnées</h2>
                <h3>Choix de la distance utilisée pour le choix de l'exception:</h3>
                {% for option in distances %}
                    <div>
                        <input type="radio" id="dist_{{ loop.index0 }}" name="distances" 
                        value="{{ option }}" {% if loop.first %}checked{% endif %} required>
                        <label for="dist_{{ loop.index0 }}">{{ option }}</label>
                    </div>
                {% endfor %}

                <h3>Choix de la méthode de sélection:</h3>
                {% for option in selection %}
                    <div>
                        <input type="radio" id="sel_{{ loop.index0 }}" name="selection" 
                        value="{{ option }}" {% if loop.first %}checked{% endif %} required>
                        <label for="sel_{{ loop.index0 }}">{{ option }}</label>
                    </div>
                {% endfor %}

                <script>
                    document.addEventListener("DOMContentLoaded", function () {
                        const radioButtons = document.querySelectorAll('input[name="selection"]');
                        const seuilContainer = document.getElementById("seuil-container");
                        const seuilInput = document.getElementById("seuil");

                        function SeuilVisibility() {
                            const selected = document.querySelector('input[name="selection"]:checked');
                            if (selected && (selected.value === "Seuil" || selected.value === "Seuil Minimal")) {
                                seuilContainer.style.display = "block";
                                seuilInput.disabled = false;
                            } else {
                                seuilContainer.style.display = "none";
                                seuilInput.disabled = true;
                            }
                        }

                        radioButtons.forEach(function (btn) {
                            btn.addEventListener("change", SeuilVisibility);
                        });

                        SeuilVisibility();
                    });
                </script>


                <div id="seuil-container" style="display: none;">
                    <label for="seuil">Choix du seuil associé: </label>
                    <input type="number" id="seuil" name="seuil" min="0" step="1"
                        value="{{ seuil if seuil is defined else 10 }}">
                </div>

                <input type="submit" value="Envoyer">
            </form>
        {% endif %}

        {% if no_exception %}
            <h3>Aucune règle suffisament proche n'a été détectée, pas de création d'exception proposée</h3>
        {% elif indices_rules is defined %}
            <h3>Voici les règles à partir desquelles nous proposons de créer une exception :</h3>

            <form method="post" action="/proposition">
                <input type="hidden" name="scenario" value="{{ scenario }}">
                <input type="hidden" name="resultat" value="{{ resultat }}">
                <textarea name="log" style="display:none;">{{ log }}</textarea>

                {% for i in range(options_rules | length) %}
                    <div style="margin-bottom: 1em; padding: 1em; border: 1px solid #ccc; border-radius: 8px;">
                        <p><strong>Règle {{ i + 1 }} :</strong> {{ options_rules[i] }}</p>

                        {% set exceptions = options_exceptions[i] %}
                        {% set adaptations = exceptions_string[i] %}

                        {% if exceptions %}
                            {% for j in range(exceptions | length) %}
                                <div style="margin: 0.5em 0;">
                                    <input type="radio"
                                        id="regle_{{ i }}_exception_{{ j }}"
                                        name="choix_exception"
                                        value="{{ i }}|{{ j }}"
                                        required
                                        {% if i == 0 and j == 0 %}checked{% endif %}>
                                    <label for="regle_{{ i }}_exception_{{ j }}">
                                        <strong>{{ exceptions[j] }}</strong> — {{ adaptations[j] }}
                                    </label>
                                </div>
                            {% endfor %}
                        {% else %}
                            <p style="margin-left: 1em; color: #666;"><em>Aucune exception connue</em></p>
                        {% endif %}
                    </div>
                {% endfor %}

                <div style="margin-top: 1em;">
                    <input type="radio" id="regle_none" name="choix_exception" value="-1" required>
                    <label for="regle_none"><strong>Ne pas sélectionner d'exception</strong></label>
                </div>

                <input type="submit" value="Valider le choix" style="margin-top: 1em;">
            </form>
        {% endif %}

        {% if pas_de_choix %}
            <h2>Pas de règle choisie: </h2>
        {% endif %}

        </main>
    </body>
</html>
